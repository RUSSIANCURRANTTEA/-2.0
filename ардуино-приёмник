// –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
#include <SoftwareSerial.h>
#include <math.h>

// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
#define MAX_MODELS 9

struct ModelResult {
  float risk;
  String level;
  String recommendation;
};

struct DiseaseProbability {
  float probability; // 0-100%
  String riskCategory;
  String colorCode;
  bool treatmentRequired;
};

struct TreatmentDate {
  bool treatmentNeeded;
  String bestDate;
  int daysToTreatment;
  String fungicideType;
  float applicationRate;
};

// –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
void setup() {
  Serial.begin(115200);
  zigbeeSerial.begin(115200);
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
}

void loop() {
  receiveZigbeeData();
  performAnalysis();
  processCommands();
}

// 1. –ú–µ—Ç–æ–¥ –£–æ–ª–ª–∏–Ω–∞
float calculateWallin(float temp, float hum, float leafWet) {
  if (temp >= 10 && temp <= 25) {
    if (hum >= 90 && leafWet >= 6) return 0.8;
    if (hum >= 80 && leafWet >= 4) return 0.5;
  }
  return 0.1;
}

// 2. BLITECAST
int countFavorableDays(DailyData history[], int count) {
  int favorable = 0;
  for (int i = 0; i < count; i++) {
    if (isFavorableDay(history[i])) favorable++;
  }
  return favorable;
}

// 3. –ú–µ—Ç–æ–¥ –≥—Ä–∞–¥—É—Å–æ-—á–∞—Å–æ–≤
float calculateDegreeHours(float temps[]) {
  float degreeHours = 0;
  for (int i = 0; i < 24; i++) {
    if (temps[i] >= 7 && temps[i] <= 30) {
      if (temps[i] >= 15 && temps[i] <= 25) degreeHours += 1.0;
      else degreeHours += 0.5;
    }
  }
  return degreeHours / 100.0;
}

// 4. –ú–µ—Ç–æ–¥ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏
float calculateHumidityDuration(float humidity[]) {
  int highHumidityHours = 0;
  for (int i = 0; i < 24; i++) {
    if (humidity[i] >= 90) highHumidityHours++;
  }
  if (highHumidityHours >= 10) return 1.0;
  if (highHumidityHours >= 8) return 0.8;
  if (highHumidityHours >= 6) return 0.6;
  if (highHumidityHours >= 4) return 0.3;
  return 0.0;
}

// 5. –ú–µ—Ç–æ–¥ —Ç–æ—á–∫–∏ —Ä–æ—Å—ã
float calculateDewPointRisk(float temp, float hum) {
  float dewPoint = calculateDewPoint(temp, hum);
  float deltaT = temp - dewPoint;
  if (deltaT <= 1) return 1.0;
  if (deltaT <= 2) return 0.8;
  if (deltaT <= 3) return 0.5;
  if (deltaT <= 4) return 0.2;
  return 0.0;
}

// 6. –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å
float calculateCombinedIndex(float temp, float hum, float rain, 
                           float leafWet, float wind) {
  float tempFactor = (temp >= 15 && temp <= 25) ? 1.0 : 0.5;
  float humFactor = hum / 100.0;
  float rainFactor = min(rain / 10.0, 1.0);
  float wetnessFactor = min(leafWet / 12.0, 1.0);
  float windFactor = max(0, 1 - wind / 8.0);
  
  return (tempFactor * 0.3 + humFactor * 0.25 + rainFactor * 0.2 +
          wetnessFactor * 0.15 + windFactor * 0.1);
}

// 7. –≠–∫—Å–ø–µ—Ä—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
float calculateExpertSystem(DailyData& data) {
  float score = 0;
  if (data.temp >= 15 && data.temp <= 25) score += 0.3;
  if (data.humidity >= 90) score += 0.3;
  if (data.leafWetness >= 8) score += 0.2;
  if (data.rainfall > 5) score += 0.2;
  return min(score, 1.0);
}

// 8. –°–æ–ª–Ω–µ—á–Ω–∞—è —Ä–∞–¥–∏–∞—Ü–∏—è
float calculateSolarRadiationRisk(float solarRad) {
  float solarFactor = solarRad / 1000.0;
  return max(0, 1 - solarFactor * 0.7); // –°–æ–ª–Ω—Ü–µ —Å–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫
}

// 9. –ü–æ—á–≤–µ–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å (SSSI)
float calculateSSSI(float soilMoisture, float soilTemp) {
  float moistureFactor = soilMoisture >= 85 ? 1.0 : 
                        soilMoisture >= 70 ? 0.5 : 0.0;
  float tempFactor = (soilTemp >= 15 && soilTemp <= 25) ? 1.0 : 
                    (soilTemp >= 10 && soilTemp <= 30) ? 0.5 : 0.0;
  return moistureFactor * tempFactor;
}

// –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –†–∞—Å—á—ë—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ —Ñ–∏—Ç–æ—Ñ—Ç–æ—Ä–æ–∑–∞
DiseaseProbability calculatePhytophthoraProbability(DailyData& current,
                                                   DailyData history[],
                                                   int historyCount) {
  DiseaseProbability result = {0, "–ù–ò–ó–ö–ò–ô", "üü¢", false};
  
  // –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π
  float modelResults[MAX_MODELS];
  
  modelResults[0] = calculateWallin(current.temp, current.humidity, 
                                   current.leafWetness);
  modelResults[1] = countFavorableDays(history, historyCount) / 15.0;
  modelResults[2] = calculateDegreeHours(current.hourlyTemps);
  modelResults[3] = calculateHumidityDuration(current.hourlyHumidity);
  modelResults[4] = calculateDewPointRisk(current.temp, current.humidity);
  modelResults[5] = calculateCombinedIndex(current.temp, current.humidity,
                                          current.rainfall, current.leafWetness,
                                          current.windSpeed);
  modelResults[6] = calculateExpertSystem(current);
  modelResults[7] = calculateSolarRadiationRisk(current.solarRadiation);
  modelResults[8] = calculateSSSI(current.soilMoisture, current.soilTemp);
  
  // –í–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ
  float weights[MAX_MODELS] = {0.15, 0.12, 0.10, 0.12, 0.10, 
                               0.15, 0.12, 0.08, 0.06};
  
  float totalRisk = 0;
  for (int i = 0; i < MAX_MODELS; i++) {
    totalRisk += modelResults[i] * weights[i];
  }
  
  // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã
  result.probability = totalRisk * 100;
  
  // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∏—Å–∫–∞
  if (result.probability >= 80) {
    result.riskCategory = "–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô";
    result.colorCode = "üü£";
    result.treatmentRequired = true;
  } 
  else if (result.probability >= 60) {
    result.riskCategory = "–í–´–°–û–ö–ò–ô";
    result.colorCode = "üî¥";
    result.treatmentRequired = true;
  }
  else if (result.probability >= 40) {
    result.riskCategory = "–ü–û–í–´–®–ï–ù–ù–´–ô";
    result.colorCode = "üü†";
    result.treatmentRequired = (current.blitecast.riskPeriod || 
                               current.humidityHours90 > 6);
  }
  else if (result.probability >= 20) {
    result.riskCategory = "–£–ú–ï–†–ï–ù–ù–´–ô";
    result.colorCode = "üü°";
    result.treatmentRequired = false;
  }
  else {
    result.riskCategory = "–ù–ò–ó–ö–ò–ô";
    result.colorCode = "üü¢";
    result.treatmentRequired = false;
  }
  
  return result;
}

// –§–£–ù–ö–¶–ò–Ø: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª—É—á—à–µ–π –¥–∞—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏
TreatmentDate calculateBestTreatmentDate(DiseaseProbability& prob,
                                        DailyData& current,
                                        WeatherForecast forecast[]) {
  TreatmentDate result = {false, "", 0, "", 0};
  
  if (!prob.treatmentRequired) {
    result.treatmentNeeded = false;
    return result;
  }
  
  result.treatmentNeeded = true;
  
  // –ê–Ω–∞–ª–∏–∑ –±–ª–∏–∂–∞–π—à–∏—Ö 7 –¥–Ω–µ–π
  int bestDay = -1;
  float bestScore = -1;
  
  for (int i = 0; i < 7; i++) {
    if (forecast[i].valid) {
      float dayScore = evaluateTreatmentDay(forecast[i], current);
      
      if (dayScore > bestScore) {
        bestScore = dayScore;
        bestDay = i;
      }
    }
  }
  
  if (bestDay >= 0) {
    result.daysToTreatment = bestDay;
    result.bestDate = formatFutureDate(bestDay);
    
    // –í—ã–±–æ—Ä —Ñ—É–Ω–≥–∏—Ü–∏–¥–∞
    if (prob.probability >= 70) {
      result.fungicideType = "–°–ò–°–¢–ï–ú–ù–´–ô + –ö–û–ù–¢–ê–ö–¢–ù–´–ô";
      result.applicationRate = 2.2;
    } 
    else if (prob.probability >= 50) {
      result.fungicideType = "–ö–û–ù–¢–ê–ö–¢–ù–û-–°–ò–°–¢–ï–ú–ù–´–ô";
      result.applicationRate = 1.8;
    }
    else {
      result.fungicideType = "–ö–û–ù–¢–ê–ö–¢–ù–´–ô (–ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–π)";
      result.applicationRate = 1.5;
    }
  }
  
  return result;
}

// –§–£–ù–ö–¶–ò–Ø: –û—Ü–µ–Ω–∫–∞ –¥–Ω—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
float evaluateTreatmentDay(WeatherForecast& forecast, DailyData& current) {
  float score = 100.0;
  
  // –í—ã—á–∏—Ç–∞–µ–º –±–∞–ª–ª—ã –∑–∞ –ø–ª–æ—Ö–∏–µ —É—Å–ª–æ–≤–∏—è
  if (forecast.rainfall > 0) score -= 40;
  if (forecast.humidity > 85) score -= 20;
  if (forecast.windSpeed > 5) score -= 30;
  if (forecast.temperature < 10 || forecast.temperature > 25) score -= 15;
  
  // –î–æ–±–∞–≤–ª—è–µ–º –±–∞–ª–ª—ã –∑–∞ —Ö–æ—Ä–æ—à–∏–µ —É—Å–ª–æ–≤–∏—è
  if (forecast.rainfall == 0) score += 20;
  if (forecast.humidity < 70) score += 10;
  if (forecast.windSpeed >= 2 && forecast.windSpeed <= 4) score += 10;
  if (forecast.temperature >= 15 && forecast.temperature <= 22) score += 15;
  
  return max(score, 0.0);
}

// –§–£–ù–ö–¶–ò–Ø: –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
void printPhytophthoraAnalysis() {
  if (agroHistoryIndex == 0) return;
  
  DailyData& latest = agroHistory[agroHistoryIndex];
  DiseaseProbability prob = calculatePhytophthoraProbability(latest, 
                                                           agroHistory, 
                                                           agroHistoryIndex);
  
  WeatherForecast forecast[7];
  initializeForecast(forecast);
  TreatmentDate treatment = calculateBestTreatmentDate(prob, latest, forecast);
  
  Serial.println("\n" + String('=') * 60);
  Serial.println("üå± –ü–†–û–ì–ù–û–ó –§–ò–¢–û–§–¢–û–†–û–ó–ê –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò");
  Serial.println(String('=') * 60);
  
  Serial.print("–í–ï–†–û–Ø–¢–ù–û–°–¢–¨ –†–ê–ó–í–ò–¢–ò–Ø: ");
  Serial.print(prob.probability, 1);
  Serial.println("%");
  
  Serial.print("–£–†–û–í–ï–ù–¨ –†–ò–°–ö–ê: ");
  Serial.print(prob.colorCode);
  Serial.print(" ");
  Serial.println(prob.riskCategory);
  
  Serial.print("–û–ë–†–ê–ë–û–¢–ö–ê –¢–†–ï–ë–£–ï–¢–°–Ø: ");
  Serial.println(prob.treatmentRequired ? "–î–ê ‚ö†" : "–ù–ï–¢ ‚úì");
  
  if (treatment.treatmentNeeded) {
    Serial.println("\nüíä –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –û–ë–†–ê–ë–û–¢–ö–ï:");
    Serial.print("–õ—É—á—à–∞—è –¥–∞—Ç–∞: ");
    Serial.println(treatment.bestDate);
    Serial.print("–î–Ω–µ–π –¥–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ");
    Serial.println(treatment.daysToTreatment);
    Serial.print("–¢–∏–ø —Ñ—É–Ω–≥–∏—Ü–∏–¥–∞: ");
    Serial.println(treatment.fungicideType);
    Serial.print("–ù–æ—Ä–º–∞ —Ä–∞—Å—Ö–æ–¥–∞: ");
    Serial.print(treatment.applicationRate, 1);
    Serial.println(" –ª/–≥–∞");
    
    Serial.println("\nüìã –ü–õ–ê–ù –û–ë–†–ê–ë–û–¢–ö–ò:");
    if (treatment.daysToTreatment == 0) {
      Serial.println("1. –û–ë–†–ê–ë–û–¢–ö–ê –°–ï–ì–û–î–ù–Ø (10:00-16:00)");
    } else if (treatment.daysToTreatment == 1) {
      Serial.println("1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ–≥–æ–¥–Ω—è");
      Serial.println("2. –û–ë–†–ê–ë–û–¢–ö–ê –ó–ê–í–¢–†–ê (—É—Ç—Ä–æ)");
    } else {
      Serial.println("1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É—Å–ª–æ–≤–∏–π (" + String(treatment.daysToTreatment) + " –¥–Ω–µ–π)");
      Serial.println("2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞ 1 –¥–µ–Ω—å –¥–æ");
      Serial.println("3. –û–ë–†–ê–ë–û–¢–ö–ê " + treatment.bestDate);
    }
  } else {
    Serial.println("\n‚úÖ –û–ë–†–ê–ë–û–¢–ö–ê –ù–ï –¢–†–ï–ë–£–ï–¢–°–Ø");
    Serial.println("–°–ª–µ–¥—É—é—â–∞—è –æ—Ü–µ–Ω–∫–∞ —á–µ—Ä–µ–∑ 3 –¥–Ω—è.");
  }
  
  Serial.println("\nüéØ –†–ï–ó–£–õ–¨–¢–ê–¢–´ 9 –ú–û–î–ï–õ–ï–ô:");
  Serial.println("1. –£–æ–ª–ª–∏–Ω: " + String(latest.wallinRisk, 2));
  Serial.println("2. BLITECAST: " + String(latest.blitecastScore, 2));
  Serial.println("3. –ì—Ä–∞–¥—É—Å–æ-—á–∞—Å—ã: " + String(latest.degreeHours, 2));
  Serial.println("4. –í–ª–∞–∂–Ω–æ—Å—Ç—å: " + String(latest.humidityRisk, 2));
  Serial.println("5. –¢–æ—á–∫–∞ —Ä–æ—Å—ã: " + String(latest.dewPointRisk, 2));
  Serial.println("6. –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π: " + String(latest.combinedRisk, 2));
  Serial.println("7. –≠–∫—Å–ø–µ—Ä—Ç–Ω–∞—è: " + String(latest.expertRisk, 2));
  Serial.println("8. –°–æ–ª–Ω–µ—á–Ω–∞—è: " + String(latest.solarRisk, 2));
  Serial.println("9. –ü–æ—á–≤–µ–Ω–Ω–∞—è: " + String(latest.soilRisk, 2));
  
  Serial.println(String('=') * 60);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã PROBABILITY
void processProbabilityCommand() {
  printPhytophthoraAnalysis();
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã TREATMENT
void processTreatmentCommand() {
  printPhytophthoraAnalysis();
}
